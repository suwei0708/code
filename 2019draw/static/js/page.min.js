function getUrlParameterByName(n){n=n.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var e=new RegExp("[\\?&]"+n+"=([^&#]*)").exec(location.search);return null===e?"":decodeURIComponent(e[1].replace(/\+/g," "))}function initPageEvents(){function n(n,e,a,t){var i=document.createElement("canvas"),o=i.getContext("2d");i.width=n.width,i.height=n.height,o.drawImage(n,0,0);for(var p=o.getImageData(0,0,i.width,i.height),r=0;r<p.data.length;r+=4)p.data[r+3]>100&&(p.data[r]=e,p.data[r+1]=a,p.data[r+2]=t);return o.putImageData(p,0,0),i}function e(e){new HGAME.source({loadCall:function(n,e){c.innerHTML="加载资源"+n+"/"+e,c.setAttribute("class","tool"),o.appendChild(c)},loaded:function(){o.removeChild(c);var a=new HGAME.Object2D({img:this.data[0],w:647,h:693,x:0,y:0});i.child=new Array,i.add(a);var t=this;a.child=new Array,each(this.data,function(i){i>=1&&a.add(new HGAME.Object2D({x:whxyInfo[e][i-1].x,y:whxyInfo[e][i-1].y,w:whxyInfo[e][i-1].w,h:whxyInfo[e][i-1].h,img:t.data[i],isClick:!0,clickFun:function(){void 0===this.bufferImg?(this.bufferImg=this.img,this.img=n(this.bufferImg,r.r,r.g,r.b)):this.img=n(this.bufferImg,r.r,r.g,r.b)}}))}),p.stop(),p.run()},data:data[e]})}document.body.addEventListener("touchmove",bodyScroll,{passive:!1});var a=!0,t=0;$(".page1").on("click",".btn-rule",function(){$(".popup-rule-box").show()}).on("click",".logo1",function(){$(".popup-intro-box").show()}).on("click",".logo3",function(){$(".popup-intro-box").show()}),$(".popup").on("click",function(n){return!1}),$(".popup-box, .popup .close").on("click",function(){$(".popup-box").hide()}),$(".page1").on("click",".btn",function(){app.swiper.slideTo(1,0,!1)}),$(".color-box").on("click","span",function(){$(this).addClass("cur").siblings().removeClass("cur")}),$(".page2").on("click",".prev",function(){--t<0&&(t=data.length-1),e(t)}).on("click",".next",function(){++t>data.length-1&&(t=0),e(t)}).on("click",".btn1",function(){$(".page3, .page4").find(".main").html(canvasToImage($("#boxRender").find("canvas")[0])),app.swiper.slideTo(2,0,!1)}).on("click",".btn2",function(){if(!a)return!1;app.userInfo.id&&$(".page5").find(".back").remove(),$(".page5").find("ul").html(""),d=!0,getData(s=1),app.swiper.slideTo(4,0,!1),document.body.removeEventListener("touchmove",bodyScroll,{passive:!1})}).on("click",".btn3",function(){app.swiper.slideTo(5,0,!1)}).on("click",".btn4",function(){e(t)}),$(".page3").on("click",".btn1",function(){app.swiper.slideTo(1,0,!1)}).on("click",".btn2",function(){if(!a)return!1;a=!1,$.ajax({url:app.baseUrl+"/save",type:"POST",dataType:"json",beforeSend:function(n){n.setRequestHeader("JWT-Token",app.token)},data:{picture:$(canvasToImage($("#boxRender").find("canvas")[0])).attr("src")}}).done(function(n){$(".page4").find(".btn1").attr("data-id",n.id),$(".popup-suc-box").show()}).fail(function(n){alert(n.responseText||"网络错误，请稍候再试！")}).always(function(){a=!0})}),$(".popup-suc-box").on("click",".btn-vote",function(){$(".popup-suc-box").hide(),app.swiper.slideTo(3,0,!1)}),$(".page4").on("click",".btn-rule",function(){$(".popup-vote-box").show()}).on("click",".btn1",function(){if(!a)return!1;vote($(this))}).on("click",".btn2",function(){$(".popup-share-box").show()}),$(".page5").on("click",".btn-rule",function(){$(".popup-vote-box").show()}).on("click",".btn",function(){if(!a)return!1;vote($(this))}),$(".back").on("click",function(){document.body.addEventListener("touchmove",bodyScroll,{passive:!1}),app.swiper.slideTo(1,0,!1)});var i=new HGAME.canvas,o=document.getElementById("boxRender");o.appendChild(i.dom);var p=new HGAME.animate({action:function(){i.render()}}),r={r:236,g:137,b:166};$(".color-box").on("click","span",function(){r.r=$(this).attr("data-r"),r.g=$(this).attr("data-g"),r.b=$(this).attr("data-b")});var c=document.createElement("div");e(t);var s=1,d=!0;$("#wrapper").on("scroll",function(){$(this).scrollTop()+$(this).height()>=$(this).find("ul").height()&&(s++,d&&getData(s))})}function checkIsPC(){var n={win:!1,mac:!1,xll:!1},e=navigator.platform;n.win=0==e.indexOf("Win"),n.mac=0==e.indexOf("Mac"),n.x11="X11"==e||0==e.indexOf("Linux");return!!($(window).width()>app.DEFAULT_WIDTH&&(n.win||n.mac||n.xll))}function hanldeAnimate(n){$(".swiper-slide").find("[data-anim]").each(function(){$(this).removeClass($(this).data("anim"))}),$(".swiper-slide").eq(n).find("[data-anim]").each(function(){$(this).addClass($(this).data("anim"))})}function bodyScroll(n){n.preventDefault()}function canvasToImage(n){var e=new Image;return e.crossOrigin="anonymous",e.src=n.toDataURL("image/jpeg"),e}function getData(n){isClicks=!1,$.ajax({url:app.baseUrl+"/index",type:"GET",dataType:"json",data:{page:n},beforeSend:function(n){n.setRequestHeader("JWT-Token",app.token)}}).done(function(n){if(n.length<=0)return loadMore=!1,!1;for(var e=0;e<n.length;e++){var a='<li><img class="img" src="./static/img/p2/main.png" alt=""><div class="btn" data-id="'+n[e].id+'""><img src="static/img/p5/btn.png"><div><span class="num">'+n[e].vote+"</span>票</div></div></li>";$(".page5").find("ul").append(a)}}).fail(function(){alert("网络错误，请稍候再试！")}).always(function(){isClicks=!0})}function vote(n){isClicks=!1,$.ajax({url:app.baseUrl+"/vote",type:"POST",dataType:"json",beforeSend:function(n){n.setRequestHeader("JWT-Token",app.token)},data:{id:n.attr("data-id")}}).done(function(e){if("投票成功"==e.responseText)return n.find(".num").html(+n.find(".num").html()+1),alert("投票成功"),!1;alert("投票失败")}).fail(function(n){console.log(n),alert(n.responseText||"网络错误，请稍候再试！")}).always(function(){isClicks=!0})}var app={};app.width,app.height,app.loop=!1,app.DEFAULT_WIDTH=750,app.DEFAULT_HEIGHT=1212,app.userInfo=[],app.token="",app.drawId=0,document.domain.indexOf(".com")<0?(app.baseUrl="http://m.xinliling.loc/api/draw",app.appId="wx6104ad130cf65c5c"):(app.baseUrl="https://m.xinliling.com/api/draw",app.appId="wx143ffe911d9d2118"),app.init=function(){app.loop=getUrlParameterByName("loop")||!1,app.drawId=getUrlParameterByName("draw_id");var n=[];$.each($("#content img"),function(e){n.push($(this).attr("src"))}),function(){var e=getUrlParameterByName("code")||!1,a=getUrlParameterByName("state"),t=location.href.split("?")[0];app.drawId&&(t+="?draw_id="+app.drawId);var i="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+app.appId+"&redirect_uri="+t+"&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect";if(!e)return window.location=i,!1;$.ajax({url:app.baseUrl+"/login",type:"GET",dataType:"json",data:{code:e,state:a}}).done(function(e){app.userInfo=e.info,app.token=e.jwt,e.hasOwnProperty("image")&&($(".page4 .user").find("img").attr("src",app.userInfo.avatar),$(".page4 .user").find("p").html(app.userInfo.nickname+"的作品")),$.imgpreload(n,{each:function(e){if("success"==($(this).data("loaded")?"success":"error")){var a=(e.length/n.length).toFixed(2);$("#percentage").width(Math.round(100*a)+"%")}},all:function(){setTimeout(function(){$(".loading").remove(),app.userInfo.subscribe||app.swiper.slideTo(6,0,!1),app.userInfo.is_end&&app.swiper.slideTo(7,0,!1),app.userInfo.id?$(".page1").find(".btn-start").remove():$(".page1").find(".btn-vote").remove()},500)}});var a=$(window).height()>app.DEFAULT_HEIGHT?$(window).height():app.DEFAULT_HEIGHT;app.swiper=new Swiper(".swiper-container",{direction:"vertical",loop:app.loop,longSwipesRatio:.1,initialSlide:1,preventClicks:!0,preventClicksPropagation:!0,width:app.DEFAULT_WIDTH,height:a,noSwiping:!0})}).fail(function(){return window.location=i,!1})}()},$(function(){app.init(),initPageEvents()});