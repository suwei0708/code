function updateStatus(){$.ajax({url:app.baseUrl+"/update",type:"GET",dataType:"json",beforeSend:function(e){e.setRequestHeader("JWT-Token",app.token)},data:{id:app.userInfo.hasOwnProperty("id")?app.userInfo.id:0}}).done(function(e){app.userInfo=e.info,app.token=e.jwt,storage.setItem("longfor-token",app.token),storage.setItem("longfor-user",JSON.stringify(app.userInfo)),pageInit()}).fail(function(){alertTips("网络错误，请稍候再试！")})}function pageInit(){var e=[];$.each($("#content img"),function(a){e.push($(this).attr("src"))}),app.userInfo.hasOwnProperty("image")&&($(".page4 .user").find("img").attr("src",app.userInfo.avatar),$(".page4 .user").find("p").html(app.userInfo.nickname+"的作品"),$(".page4").find(".main").html('<img src="'+app.userInfo.image+'">'),$(".page4").find(".num").html(app.userInfo.vote),$(".page4").find(".btn1").attr("data-id",app.userInfo.id)),$.imgpreload(e,{each:function(a){if("success"==($(this).data("loaded")?"success":"error")){var t=(a.length/e.length).toFixed(2);$("#percentage").width(Math.round(100*t)+"%")}},all:function(){setTimeout(function(){if(app.userInfo.is_end)return $(".loading").remove(),app.swiper.slideTo(7,0,!1),!1;app.drawId&&app.drawId!=app.userInfo.id?$.ajax({url:app.baseUrl+"/view",type:"GET",dataType:"json",beforeSend:function(e){e.setRequestHeader("JWT-Token",app.token)},data:{id:app.drawId}}).done(function(e){$(".page9 .user").find("img").attr("src",e.avatar),$(".page9 .user").find("p").html(e.nickname+"的作品"),$(".page9").find(".main").html('<img src="'+e.image+'">'),$(".page9").find(".num").html(e.vote),$(".page9").find(".btn1").attr("data-id",e.id),app.swiper.slideTo(8,0,!1),$(".loading").remove()}).fail(function(e){alertTips(e.responseText||"网络错误，请稍候再试！")}).always(function(){isClicks=!0}):($(".loading").remove(),app.userInfo.id?$(".page1").find(".btn-start").remove():$(".page1").find(".btn-vote").remove())},500)}});var a=$(window).height()>app.DEFAULT_HEIGHT?$(window).height():app.DEFAULT_HEIGHT;app.swiper=new Swiper(".swiper-container",{direction:"vertical",loop:app.loop,longSwipesRatio:.1,initialSlide:0,preventClicks:!0,preventClicksPropagation:!0,width:app.DEFAULT_WIDTH,height:a,noSwiping:!0})}function getUrlParameterByName(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var a=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(location.search);return null===a?"":decodeURIComponent(a[1].replace(/\+/g," "))}function initPageEvents(){function e(e,a,t,n){var i=document.createElement("canvas"),o=i.getContext("2d");i.width=e.width,i.height=e.height,o.drawImage(e,0,0);for(var p=o.getImageData(0,0,i.width,i.height),r=0;r<p.data.length;r+=4)p.data[r+3]>100&&(p.data[r]=a,p.data[r+1]=t,p.data[r+2]=n);return o.putImageData(p,0,0),console.log(i,"c"),i}function a(a){HGAME.event.clickBuffer=[];var t=document.createElement("div");new HGAME.source({loadCall:function(e,a){t.innerHTML="加载资源"+e+"/"+a,t.setAttribute("class","tool"),o.appendChild(t)},loaded:function(){o.removeChild(t),app.img=new HGAME.Object2D({img:this.data[0],w:647,h:693,x:0,y:0}),i.child=new Array,i.add(app.img);var n=this;app.img.child=new Array,each(this.data,function(t){t>=1&&app.img.add(new HGAME.Object2D({x:whxyInfo[a][t-1].x,y:whxyInfo[a][t-1].y,w:whxyInfo[a][t-1].w,h:whxyInfo[a][t-1].h,img:n.data[t],isClick:!0,clickFun:function(){void 0===this.bufferImg?(this.bufferImg=this.img,this.img=e(this.bufferImg,r.r,r.g,r.b)):this.img=e(this.bufferImg,r.r,r.g,r.b),app.hisArr.push({img:this.bufferImg,r:r.r,g:r.g,b:r.b})}}))}),p.stop(),p.run()},data:data[a]})}document.body.addEventListener("touchmove",bodyScroll,{passive:!1});var t=!0,n=0;$(".page1").on("click",".btn-rule",function(){$(".popup-rule-box").show()}).on("click",".logo1",function(){$(".popup-intro-box").show()}).on("click",".logo3",function(){$(".popup-intro-box").show()}).on("click",".btn-start",function(){app.swiper.slideTo(1,0,!1)}).on("click",".btn-vote",function(){if(!t)return!1;share(app.userInfo.id),app.swiper.slideTo(3,0,!1)}),$(".popup").on("click",function(e){return!1}),$(".popup-box, .popup .close").on("click",function(){$(".popup-box").hide()}),$(".color-box").on("click","span",function(){$(this).addClass("cur").siblings().removeClass("cur")}),$(".page2").on("click",".prev",function(){--n<0&&(n=data.length-1),a(n)}).on("click",".next",function(){++n>data.length-1&&(n=0),a(n)}).on("click",".btn1",function(){$(".page3, .page4").find(".main").html(canvasToImage($("#boxRender").find("canvas")[0])),app.swiper.slideTo(2,0,!1)}).on("click",".btn3",function(){app.swiper.slideTo(5,0,!1)}).on("click",".btn4",function(){a(n)}),$(".page3").on("click",".btn2",function(){if(!t)return!1;t=!1,$.ajax({url:app.baseUrl+"/save",type:"POST",dataType:"json",beforeSend:function(e){e.setRequestHeader("JWT-Token",app.token)},data:{picture:$(canvasToImage($("#boxRender").find("canvas")[0])).attr("src")}}).done(function(e){app.userInfo.id=e.id,app.userInfo.image=e.image,app.userInfo.vote=0,storage.setItem("longfor-user",JSON.stringify(app.userInfo)),$(".page4").find(".btn1").attr("data-id",e.id),$(".popup-suc-box").show()}).fail(function(e){alertTips(e.responseText||"网络错误，请稍候再试！")}).always(function(){t=!0})}),$(".page3").on("click",".btn1",function(){app.swiper.slideTo(1,0,!1)}),$(".page2 .btn2, .page4 .everywork, .page9 .everywork").on("click",function(){if(!t)return!1;app.userInfo.id&&$(".page5").find(".back").remove(),app.rank||($(".page5").find("ul").html(""),app.pageNum=1,app.loadMore=!0,getData(app.pageNum)),share(),app.swiper.slideTo(4,0,!1),document.body.removeEventListener("touchmove",bodyScroll,{passive:!1})}),$(".page5, .page4, .page9").on("click",".btn",function(){if(!t)return!1;if(!app.userInfo.subscribe)return app.swiper.slideTo(6,0,!1),!1;vote($(this))}),$(".popup-suc-box").on("click",".btn-vote",function(){$(".popup-suc-box").hide(),share(app.userInfo.id),app.swiper.slideTo(3,0,!1)}),$(".page4, .page9").on("click",".btn-rule",function(){$(".popup-vote-box").show()}),$(".page4").on("click ",".btn2 ",function(){$(".popup-share-box").show()}),$(".page9").on("click",".btn2",function(){app.swiper.slideTo(1,0,!1)}),$(".page5").on("click",".btn-rule",function(){$(".popup-vote-box").show()}).on("click",".mywork",function(){if(!t)return!1;share(app.userInfo.id),app.swiper.slideTo(3,0,!1)}),$(".back").on("click",function(){document.body.addEventListener("touchmove",bodyScroll,{passive:!1}),app.swiper.slideTo(1,0,!1)});var i=new HGAME.canvas;app.hisArr=[];var o=document.getElementById("boxRender");o.appendChild(i.dom);var p=new HGAME.animate({action:function(){i.render()}}),r={r:236,g:137,b:166};$(".color-box").on("click","span",function(){r.r=$(this).attr("data-r"),r.g=$(this).attr("data-g"),r.b=$(this).attr("data-b")}),a(n),$("#drawback").on("click",function(){app.hisArr.length--;var a=app.hisArr.length-1;console.log(app.img.img,"app.img.img"),app.img.img=e(app.hisArr[a].img,app.hisArr[a].r,app.hisArr[a].g,app.hisArr[a].b),console.log(app.img.img,"backimg"),p.run()}),$("#wrapper").on("scroll",function(){$(this).scrollTop()+$(this).height()>=$(this).find("ul").height()&&app.loadMore&&getData(app.pageNum)})}function checkIsPC(){var e={win:!1,mac:!1,xll:!1},a=navigator.platform;e.win=0==a.indexOf("Win"),e.mac=0==a.indexOf("Mac"),e.x11="X11"==a||0==a.indexOf("Linux");return!!($(window).width()>app.DEFAULT_WIDTH&&(e.win||e.mac||e.xll))}function hanldeAnimate(e){$(".swiper-slide").find("[data-anim]").each(function(){$(this).removeClass($(this).data("anim"))}),$(".swiper-slide").eq(e).find("[data-anim]").each(function(){$(this).addClass($(this).data("anim"))})}function bodyScroll(e){e.preventDefault()}function canvasToImage(e){var a=new Image;return a.crossOrigin="anonymous",a.src=e.toDataURL("image/jpeg",.8),a}function getData(e){isClicks=!1,app.rank=!0,1==e&&$(".spinner-box").show(),$.ajax({url:app.baseUrl+"/index",type:"GET",dataType:"json",data:{page:e},beforeSend:function(e){e.setRequestHeader("JWT-Token",app.token)}}).done(function(e){if(e.length<=0)return app.loadMore=!1,!1;for(var a=0;a<e.length;a++){var t='<li><img class="img" src="'+e[a].image+'" alt=""><div class="btn" data-id="'+e[a].id+'""><img src="static/img/p5/btn.png"><div><span class="num">'+e[a].vote+"</span>票</div></div></li>";$(".page5").find("ul").append(t)}app.pageNum++}).fail(function(){alertTips("网络错误，请稍候再试！")}).always(function(){isClicks=!0,1==e&&$(".spinner-box").hide()})}function vote(e){if(app.voteNum>2)return alertTips("您今天的投票次数已经用完！"),!1;isClicks=!1,$(".spinner-box").show(),$.ajax({url:app.baseUrl+"/vote",type:"POST",dataType:"json",beforeSend:function(e){e.setRequestHeader("JWT-Token",app.token)},data:{id:e.attr("data-id")}}).done(function(a){e.find(".num").html(+e.find(".num").html()+1),alertTips("投票成功"),app.voteNum++,storage.setItem(today,app.voteNum)}).fail(function(a){"投票成功"==a.responseText&&(e.find(".num").html(+e.find(".num").html()+1),app.voteNum++,storage.setItem(today,app.voteNum)),alertTips(a.responseText||"网络错误，请稍候再试！")}).always(function(){isClicks=!0,$(".spinner-box").hide()})}function alertTips(e,a){$(".alerttips-box").length||($("#content").append('<div class="alerttips-box"><div class="alerttips"></div></div>'),$("body").append()),$(".alerttips").html(e),$(".alerttips-box").show(),time=a||2e3,clearTimeout(alertTimes),alertTimes=setTimeout(function(){$(".alerttips-box").hide()},time)}function share(e){var a=window.location.href,t=a.substr(0,a.lastIndexOf("/")+1);if(e){n={link:t+"index.html?draw_id="+e};weixin.bindData(n)}else{var n={link:t+"index.html"};weixin.bindData(n)}}var app={};app.width,app.height,app.loop=!1,app.DEFAULT_WIDTH=750,app.DEFAULT_HEIGHT=1212,app.userInfo=[],app.token="",app.drawId=0,app.loadMore=!0,app.pageNum=1,app.img,document.domain.indexOf(".com")<0?(app.baseUrl="http://m.xinliling.loc/api/draw",app.appId="wx6104ad130cf65c5c"):(app.baseUrl="https://m.xinliling.com/api/draw",app.appId="wx143ffe911d9d2118"),app.rank=!1,app.voteNum=0;var storage=window.localStorage;app.token=storage.getItem("longfor-token")||"",app.token&&(app.userInfo=JSON.parse(storage.getItem("longfor-user")));var today=(new Date).toLocaleDateString(),todayNum=storage.getItem(today);null!==todayNum?app.voteNum=+todayNum:(storage.removeItem(new Date((new Date).getTime()-864e5).toLocaleDateString()),storage.setItem(today,app.voteNum)),app.init=function(){app.loop=getUrlParameterByName("loop")||!1,app.drawId=getUrlParameterByName("draw_id"),app.token?(app.userInfo.is_end&&pageInit(),updateStatus()):function(){var e=getUrlParameterByName("code")||!1,a=getUrlParameterByName("state"),t=location.href.split("?")[0];app.drawId&&(t+="?draw_id="+app.drawId);var n="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+app.appId+"&redirect_uri="+t+"&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect";if(!e)return window.location.replace=n,!1;$.ajax({url:app.baseUrl+"/login",type:"GET",dataType:"json",data:{code:e,state:a}}).done(function(e){app.userInfo=e.info,app.token=e.jwt,storage.setItem("longfor-token",app.token),storage.setItem("longfor-user",JSON.stringify(app.userInfo)),pageInit()}).fail(function(){return window.location.replace=n,!1})}()},$(function(){app.init(),initPageEvents()});var alertTimes;