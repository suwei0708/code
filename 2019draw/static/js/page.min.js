function updateStatus(){$.ajax({url:app.baseUrl+"/update",type:"GET",dataType:"json",beforeSend:function(e){e.setRequestHeader("JWT-Token",app.token)},data:{id:app.userInfo.hasOwnProperty("id")?app.userInfo.id:0}}).done(function(e){app.userInfo=e.info,app.token=e.jwt,storage.setItem("longfor-token",app.token),storage.setItem("longfor-user",JSON.stringify(app.userInfo)),pageInit()}).fail(function(){alertTips("网络错误，请稍候再试！")})}function pageInit(){var e=[];$.each($("#content img"),function(a){e.push($(this).attr("src"))}),$(".page4 .user").find("img").attr("src",app.userInfo.avatar),$(".page4 .user").find("p").html(app.userInfo.nickname+"的作品"),app.userInfo.hasOwnProperty("image")&&($(".page4").find(".main").html('<img src="/'+app.userInfo.image+'">'),$(".page4").find(".num").html(app.userInfo.vote),$(".page4").find(".btn1").attr("data-id",app.userInfo.id)),$.imgpreload(e,{each:function(a){if("success"==($(this).data("loaded")?"success":"error")){var n=(a.length/e.length).toFixed(2);$("#percentage").width(Math.round(100*n)+"%")}},all:function(){setTimeout(function(){if(app.userInfo.is_end)return $(".loading").remove(),app.swiper.slideTo(7,0,!1),!1;app.drawId&&app.drawId!=app.userInfo.id?$.ajax({url:app.baseUrl+"/view",type:"GET",dataType:"json",beforeSend:function(e){e.setRequestHeader("JWT-Token",app.token)},data:{id:app.drawId}}).done(function(e){$(".page9 .user").find("img").attr("src",e.avatar),$(".page9 .user").find("p").html(e.nickname+"的作品"),$(".page9").find(".main").html('<img src="/'+e.image+'">'),$(".page9").find(".num").html(e.vote),$(".page9").find(".btn1").attr("data-id",e.id),app.swiper.slideTo(8,0,!1),$(".loading").remove()}).fail(function(e){alertTips(e.responseText||"网络错误，请稍候再试！")}).always(function(){isClicks=!0}):($(".loading").remove(),app.userInfo.id?$(".btn-start").remove():$(".btn-vote").remove())},500)}});var a=$(window).height();app.swiper=new Swiper(".swiper-container",{direction:"vertical",loop:app.loop,longSwipesRatio:.1,initialSlide:app.initialSlide,preventClicks:!0,preventClicksPropagation:!0,width:app.DEFAULT_WIDTH,height:a,noSwiping:!0})}function getUrlParameterByName(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var a=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(location.search);return null===a?"":decodeURIComponent(a[1].replace(/\+/g," "))}function initPageEvents(){function e(e,a,n,i){var t=document.createElement("canvas"),p=t.getContext("2d");t.width=e.width,t.height=e.height,p.drawImage(e,0,0);for(var o=p.getImageData(0,0,t.width,t.height),r=0;r<o.data.length;r+=4)o.data[r+3]>100&&(o.data[r]=a,o.data[r+1]=n,o.data[r+2]=i);return p.putImageData(o,0,0),t}function a(a){app.hisArr=[],HGAME.event.clickBuffer=[];var n=document.createElement("div");new HGAME.source({loadCall:function(e,a){n.innerHTML="加载资源"+e+"/"+a,n.setAttribute("class","tool"),p.appendChild(n)},loaded:function(){p.removeChild(n),app.img=new HGAME.Object2D({img:this.data[0],w:647,h:693,x:0,y:0}),t.child=new Array,t.add(app.img);var i=this;app.img.child=new Array,each(this.data,function(n){n>=1&&app.img.add(new HGAME.Object2D({x:whxyInfo[a][n-1].x,y:whxyInfo[a][n-1].y,w:whxyInfo[a][n-1].w,h:whxyInfo[a][n-1].h,img:i.data[n],isClick:!0,clickFun:function(){void 0===this.bufferImg?(this.bufferImg=this.img,this.img=e(this.bufferImg,r.r,r.g,r.b)):this.img=e(this.bufferImg,r.r,r.g,r.b),app.hisArr.push({img:this.bufferImg,r:r.r,g:r.g,b:r.b,cur:this.bufferImg.src.substring(this.bufferImg.src.lastIndexOf("/")+1,this.bufferImg.src.length).replace(".png","")-1})}}))}),o.stop(),o.run()},data:data[a]})}document.body.addEventListener("touchmove",bodyScroll,{passive:!1});var n=!0,i=0;$(".page1").on("click",".btn-rule",function(){$(".popup-rule-box").show()}).on("click",".btn",function(){hanldeAnimate(9),app.swiper.slideTo(9,0,!1)}),$(".btn-start").on("click",function(){app.swiper.slideTo(1,0,!1)}),$(".btn-vote").on("click",function(){if(!n)return!1;share(app.userInfo.id),app.swiper.slideTo(3,0,!1)}),$(".popup").on("click",function(e){return!1}),$(".popup-box, .popup .close").on("click",function(){$(".popup-box").hide()}),$(".color-box").on("click","span",function(){$(this).addClass("cur").siblings().removeClass("cur")}),$(".page2").on("click",".prev",function(){--i<0&&(i=data.length-1),a(i)}).on("click",".next",function(){++i>data.length-1&&(i=0),a(i)}).on("click",".btn1",function(){$(".page3, .page4").find(".main").html(canvasToImage($("#boxRender").find("canvas")[0])),app.swiper.slideTo(2,0,!1)}).on("click",".btn3",function(){app.swiper.slideTo(5,0,!1)}).on("click",".btn4",function(){a(i)}),$(".page3").on("click",".btn2",function(){if(!n)return!1;n=!1,$(".spinner-box").show(),$.ajax({url:app.baseUrl+"/save",type:"POST",dataType:"json",beforeSend:function(e){e.setRequestHeader("JWT-Token",app.token)},data:{picture:$(canvasToImage($("#boxRender").find("canvas")[0])).attr("src")}}).done(function(e){app.userInfo.id=e.id,app.userInfo.image=e.image,app.userInfo.vote=0,storage.setItem("longfor-user",JSON.stringify(app.userInfo)),$(".page4").find(".btn1").attr("data-id",e.id),$(".popup-suc-box").show()}).fail(function(e){alertTips(e.responseText||"网络错误，请稍候再试！")}).always(function(){n=!0,$(".spinner-box").hide()})}),$(".page3").on("click",".btn1",function(){app.swiper.slideTo(1,0,!1)}),$(".page2 .btn2, .page4 .everywork, .page9 .everywork").on("click",function(){if(!n)return!1;app.userInfo.id&&$(".page5").find(".back").remove(),app.rank||($(".page5").find("ul").html(""),app.pageNum=1,app.loadMore=!0,getData(app.pageNum)),share(),app.swiper.slideTo(4,0,!1),document.body.removeEventListener("touchmove",bodyScroll,{passive:!1})}),$(".page5, .page4, .page9").on("click",".btn",function(){if(!n)return!1;if(!app.userInfo.subscribe)return app.swiper.slideTo(6,0,!1),!1;vote($(this))}),$(".popup-suc-box").on("click",".btn-vote",function(){$(".popup-suc-box").hide(),share(app.userInfo.id),app.swiper.slideTo(3,0,!1)}),$(".page4, .page9").on("click",".btn-rule",function(){$(".popup-vote-box").show()}),$(".page4").on("click ",".btn2 ",function(){$(".popup-share-box").show()}),$(".page9").on("click",".btn2",function(){app.swiper.slideTo(1,0,!1)}),$(".page5").on("click",".btn-rule",function(){$(".popup-vote-box").show()}).on("click",".mywork",function(){if(!n)return!1;share(app.userInfo.id),app.swiper.slideTo(3,0,!1),document.body.addEventListener("touchmove",bodyScroll,{passive:!1})}),$(".back").on("click",function(){document.body.addEventListener("touchmove",bodyScroll,{passive:!1}),app.swiper.slideTo(1,0,!1)});var t=new HGAME.canvas;app.hisArr=[];var p=document.getElementById("boxRender");p.appendChild(t.dom);var o=new HGAME.animate({action:function(){t.render()}}),r={r:236,g:137,b:166};$(".color-box").on("click","span",function(){r.r=$(this).attr("data-r"),r.g=$(this).attr("data-g"),r.b=$(this).attr("data-b")}),a(i),$("#drawback").on("click",function(){if(app.hisArr.length<=0)return!1;var a=app.hisArr.length-1;if(a>0)for(var n=a-1;n>=0;n--){if(app.hisArr[a].cur==app.hisArr[n].cur)return app.img.child[app.hisArr[a].cur].img=e(app.hisArr[n].img,app.hisArr[n].r,app.hisArr[n].g,app.hisArr[n].b),app.hisArr.pop(),!1;app.img.child[app.hisArr[a].cur].img=e(app.hisArr[a].img,255,255,255)}else app.img.child[app.hisArr[a].cur].img=e(app.hisArr[a].img,255,255,255);app.hisArr.pop()}),$("#eraser").on("click",function(){r={r:255,g:255,b:255},$(".color-box").find("span").removeClass("cur")}),$("#wrapper").on("scroll",function(){$(this).scrollTop()+$(this).height()>=$(this).find("ul").height()&&app.loadMore&&getData(app.pageNum)}),$(".page10").on("click",".btn",function(){hanldeAnimate(5),app.swiper.slideTo(5,0,!1)}),$(".btn-replay").on("click",function(){app.swiper.slideTo(0,0,!1)})}function checkIsPC(){var e={win:!1,mac:!1,xll:!1},a=navigator.platform;e.win=0==a.indexOf("Win"),e.mac=0==a.indexOf("Mac"),e.x11="X11"==a||0==a.indexOf("Linux");return!!($(window).width()>app.DEFAULT_WIDTH&&(e.win||e.mac||e.xll))}function hanldeAnimate(e){$(".swiper-slide").find("[data-anim]").each(function(){$(this).removeClass($(this).data("anim"))}),$(".swiper-slide").eq(e).find("[data-anim]").each(function(){$(this).addClass($(this).data("anim"))})}function bodyScroll(e){e.preventDefault()}function canvasToImage(e){var a=new Image;return a.crossOrigin="anonymous",a.src=e.toDataURL("image/jpeg",.8),a}function getData(e){isClicks=!1,app.rank=!0,1==e&&$(".spinner-box").show(),$.ajax({url:app.baseUrl+"/index",type:"GET",dataType:"json",data:{page:e},beforeSend:function(e){e.setRequestHeader("JWT-Token",app.token)}}).done(function(e){if(e.length<=0)return app.loadMore=!1,!1;for(var a=0;a<e.length;a++){var n='<li><img class="img" src="/'+e[a].image+'" alt=""><div class="btn" data-id="'+e[a].id+'""><img src="static/img/p5/btn.png"><div><span class="num">'+e[a].vote+"</span>票</div></div></li>";$(".page5").find("ul").append(n)}app.pageNum++}).fail(function(){alertTips("网络错误，请稍候再试！")}).always(function(){isClicks=!0,1==e&&$(".spinner-box").hide()})}function vote(e){if(app.voteNum>2)return alertTips("您今天的投票次数已经用完！"),!1;isClicks=!1,$(".spinner-box").show(),$.ajax({url:app.baseUrl+"/vote",type:"POST",dataType:"json",beforeSend:function(e){e.setRequestHeader("JWT-Token",app.token)},data:{id:e.attr("data-id")}}).done(function(a){e.find(".num").html(+e.find(".num").html()+1),alertTips("投票成功"),app.voteNum++,storage.setItem(today,app.voteNum)}).fail(function(a){"投票成功"==a.responseText&&(e.find(".num").html(+e.find(".num").html()+1),app.voteNum++,storage.setItem(today,app.voteNum)),alertTips(a.responseText||"网络错误，请稍候再试！")}).always(function(){isClicks=!0,$(".spinner-box").hide()})}function alertTips(e,a){$(".alerttips-box").length||($("#content").append('<div class="alerttips-box"><div class="alerttips"></div></div>'),$("body").append()),$(".alerttips").html(e),$(".alerttips-box").show(),time=a||2e3,clearTimeout(alertTimes),alertTimes=setTimeout(function(){$(".alerttips-box").hide()},time)}function share(e){var a=window.location.href,n=a.substr(0,a.lastIndexOf("/")+1);e?(wxData={link:n+"index.html?draw_id="+e},weixin.bindData(wxData),weixin.bindShareInfo()):(wxData={link:n+"index.html"},weixin.bindData(wxData),weixin.bindShareInfo())}var app={};app.width,app.height,app.loop=!1,app.DEFAULT_WIDTH=750,app.DEFAULT_HEIGHT=1212,app.userInfo=[],app.token="",app.drawId=0,app.loadMore=!0,app.pageNum=1,app.music=$("audio")[0],app.img,app.initialSlide=0,document.domain.indexOf(".com")<0?(app.baseUrl="http://m.xinliling.loc/api/draw",app.appId="wx6104ad130cf65c5c"):(app.baseUrl="https://m.xinliling.com/api/draw",app.appId="wx143ffe911d9d2118"),app.rank=!1,app.voteNum=0;var storage=window.localStorage;app.token=storage.getItem("longfor-token")||"",app.token&&(app.userInfo=JSON.parse(storage.getItem("longfor-user")));var today=(new Date).toLocaleDateString(),todayNum=storage.getItem(today);null!==todayNum?app.voteNum=+todayNum:(storage.removeItem(new Date((new Date).getTime()-864e5).toLocaleDateString()),storage.setItem(today,app.voteNum)),app.init=function(){app.music&&app.music.play(),document.addEventListener("WeixinJSBridgeReady",function(){app.music.play()},!1),app.loop=getUrlParameterByName("loop")||!1,app.drawId=getUrlParameterByName("draw_id"),pageInit()},$(function(){app.init(),initPageEvents()});var alertTimes;