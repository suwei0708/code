function getUrlParameterByName(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(location.search);return null===t?"":decodeURIComponent(t[1].replace(/\+/g," "))}function initPageEvents(){document.body.addEventListener("touchmove",bodyScroll,{passive:!1}),$("body").on("click",function(){$(".share-box").is(":visible")&&$(".share-box").hide()}),localStorage.getItem("author")&&$("#form input[name=author]").val(localStorage.getItem("author")),$(".page0").on("click",function(){app.swiper.slideTo(1,0,!1),hanldeAnimate(1)}),$(".page0").on("click",".btn",function(){return app.swiper.slideTo(2,0,!1),hanldeAnimate(2),!1}),$(".page1").on("click",".btn1",function(){$(".rule-box").fadeIn()}),$(".page1").on("click",".btn2",function(){app.swiper.slideTo(2,0,!1),hanldeAnimate(2)}),$(".rule-box").on("click",function(){$(this).hide()});var e=1;$(".btn-switch").on("click",function(){var t=rnd(1,31);t==e&&(31==t?t=1:t++),e=t,$("#ringoImage").attr("src","static/img/temp/temp"+e+".jpg")});var t=[];$(".page2").on("click",".btn1",function(){if(!isClick)return!1;$.ajax({url:"https://m.xinliling.com/poems/list",type:"GET",dataType:"json",data:{uid:localStorage.getItem("uid")}}).done(function(e){if(0==e.list.length)return alert("您暂未发布作品！"),!1;t=e.list;for(var i="",n=0;n<t.length;n++){i+='<li><img src="static/img/temp/temp'+t[n].content.split("::")[3]+'.jpg" alt=""><p>'+t[n].title+"</p></li>"}$(".page4 .list ul").html(i),document.body.removeEventListener("touchmove",bodyScroll,{passive:!1}),app.swiper.slideTo(4,0,!1),hanldeAnimate(4)}).fail(function(){alert("网络错误，请稍后重试")}).always(function(){isClick=1})}),$(".page2").on("click",".btn2",function(){if(!isClick)return!1;var t=$.trim($("#form input[name=title]").val()),i=$.trim($("#form input[name=text1]").val()),n=$.trim($("#form input[name=text2]").val()),a=$.trim($("#form input[name=text3]").val()),o=$.trim($("#form input[name=author]").val()),r=document.getElementById("ringoImage"),l=document.getElementById("bg"),c=document.getElementById("ecode");if(!$.trim(t))return alert("标题不能为空！"),!1;if(!$.trim(i))return alert("第一行字不能为空！"),!1;if(!$.trim(n))return alert("第二行字不能为空！"),!1;if(!$.trim(a))return alert("第三行字不能为空！"),!1;if(!$.trim(o))return alert("作者不能为空！"),!1;$("#form input[name=uid]").val(localStorage.getItem("uid"));var p=i+"::"+n+"::"+a+"::"+e;return $("#form input[name=text]").val(p),isClick=0,$("#form input[name=title]").focus(),$.ajax({url:"https://m.xinliling.com/poems",type:"POST",dataType:"json",data:$("#form").serialize()}).done(function(e){var p=window.location.href,m=p.substr(0,p.lastIndexOf("/")+1),s={title:$.trim($("#form input[name=author]").val())+"，2019，为长沙写首诗 ",imgUrl:m+$("#ringoImage").attr("src"),desc:"诗意狂欢，和一座城市跨年"};weixin.bindData(s),weixin.bindShareInfo(),localStorage.setItem("uid",e.uid),localStorage.setItem("author",o);var d=convertImageToCanvas(l,r,c,t,i,n,a,o);document.getElementById("canvasHolder").appendChild(d),document.getElementById("pngHolder").appendChild(convertCanvasToImage(d)),$("#form input[name=title]").blur(),alert("发布成功！"),app.swiper.slideTo(3,0,!1)}).fail(function(e){422==e.status?alert(e.responseText):alert("网络错误，请稍后重试")}).always(function(){isClick=1}),!1}),$(".page4").on("click","li",function(){document.body.addEventListener("touchmove",bodyScroll,{passive:!1});var e=$(this).index(),i=t[e].content.split("::"),n=t[e].title,a=i[0],o=i[1],r=i[2],l=t[e].author,c=document.getElementById("ringoImage"),p=document.getElementById("bg"),m=document.getElementById("ecode");c.src="static/img/temp/temp"+i[3]+".jpg";var s=window.location.href,d=s.substr(0,s.lastIndexOf("/")+1),u={title:$.trim($("#form input[name=author]").val())+"，2019，为长沙写首诗 ",imgUrl:d+$("#ringoImage").attr("src"),desc:"诗意狂欢，和一座城市跨年"};weixin.bindData(u),weixin.bindShareInfo();var g=convertImageToCanvas(p,c,m,n,a,o,r,l);document.getElementById("canvasHolder").appendChild(g),document.getElementById("pngHolder").appendChild(convertCanvasToImage(g)),app.swiper.slideTo(3,0,!1)})}function hanldeAnimate(e){$(".swiper-slide").find("[data-anim]").each(function(){$(this).removeClass($(this).data("anim"))}),$(".swiper-slide").eq(e).find("[data-anim]").each(function(){$(this).addClass($(this).data("anim"))})}function isIOS(){var e=navigator.userAgent;navigator.appVersion;return!!!!e.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)}function convertImageToCanvas(e,t,i,n,a,o,r,l){var c=document.createElement("canvas");c.width=e.width,c.height=e.height;var p=c.getContext("2d");return p.save(),p.drawImage(e,0,0),p.drawImage(t,48,70,654,558),p.drawImage(i,569,1046,135,135),p.fillStyle="#2e3192",p.font="60px Microsoft Yahei",p.fillText(n,100,756),p.font="30px Microsoft Yahei",p.fillText(a,105,833),p.fillText(o,105,869),p.fillText(r,105,905),p.font="21px Microsoft Yahei",p.fillText(l,105,970),p.fillStyle="#999",p.font="18px Microsoft Yahei",p.fillText("*长按保存图片",105,1042),p.restore(),p.stroke(),c}function convertCanvasToImage(e){var t=new Image;return t.crossOrigin="anonymous",t.src=e.toDataURL("image/png"),t}function rnd(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function bodyScroll(e){e.preventDefault()}var app={},resultNum=0,isClick=1;app.width,app.height,app.loop=!1,app.DEFAULT_WIDTH=750,app.DEFAULT_HEIGHT=1218,app.baseUrl="static/img/",app.music=$("audio")[0],app.init=function(){app.music&&app.music.play(),document.addEventListener("WeixinJSBridgeReady",function(){app.music.play()},!1),app.loop=getUrlParameterByName("loop")||!1;var e=[];$.each($("#content img"),function(t){e.push($(this).attr("src"))}),$.imgpreload(e,{each:function(e){$(this).data("loaded")},all:function(){setTimeout(function(){$(".loading").hide(),hanldeAnimate(0)},500)}});var t=$(window).height()>app.DEFAULT_HEIGHT?$(window).height():app.DEFAULT_HEIGHT;app.swiper=new Swiper(".swiper-container",{direction:"vertical",loop:app.loop,allowTouchMove:!1,longSwipesRatio:.1,initialSlide:0,preventClicks:!0,preventClicksPropagation:!0,width:app.DEFAULT_WIDTH,height:t,noSwiping:!0})},$(function(){app.init(),initPageEvents()});var result=[];